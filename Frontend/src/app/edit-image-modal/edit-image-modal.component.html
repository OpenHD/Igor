<!-- Modern OpenHD Edit Image Modal -->
<div class="modern-modal">
  <div class="modal-header">
    <h4 class="modal-title">
      <i class="bi bi-card-image me-2"></i>
      {{ image?.id ? 'Edit OS Image' : 'New OS Image' }}
    </h4>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <form [formGroup]="imageForm" (ngSubmit)="onSubmit()" class="modal-form">
      <div class="modal-content-grid">
        <!-- Left Column: Basic Info & Settings -->
        <div class="left-column">
          <!-- Basic Information -->
          <div class="form-card">
            <h3 class="card-title">
              <i class="bi bi-info-circle"></i>Basic Information
            </h3>
            
            <div class="form-row">
              <div class="form-group">
                <label>
                  <i class="bi bi-tag"></i>Name<span class="required">*</span>
                </label>
                <input type="text" 
                  formControlName="name" 
                  placeholder="Enter OS image name">
                @if (imageForm.get('name')?.invalid && imageForm.get('name')?.touched) {
                  <div class="field-error">
                    <i class="bi bi-exclamation-triangle"></i>Name is required
                  </div>
                }
              </div>
              <div class="form-group">
                <label>
                  <i class="bi bi-folder"></i>Category
                </label>
                <select formControlName="categoryId">
                  <option value="">Select category</option>
                  @for (category of categories; track category.id) {
                    <option [value]="category.id">{{ category.name }}</option>
                  }
                </select>
              </div>
            </div>

            <div class="form-row single">
              <div class="form-group">
                <label>
                  <i class="bi bi-text-paragraph"></i>Description<span class="required">*</span>
                </label>
                <textarea 
                  formControlName="description" 
                  placeholder="Enter a detailed description"
                  rows="3"></textarea>
                @if (imageForm.get('description')?.invalid && imageForm.get('description')?.touched) {
                  <div class="field-error">
                    <i class="bi bi-exclamation-triangle"></i>Description is required
                  </div>
                }
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <i class="bi bi-download"></i>Downloads
                </label>
                <input type="number" 
                  formControlName="redirectsCount" 
                  placeholder="0"
                  readonly>
              </div>
              <div class="form-group">
                <label>
                  <i class="bi bi-toggle-on"></i>Status
                </label>
                <select formControlName="isEnabled">
                  <option [value]="true">Enabled</option>
                  <option [value]="false">Disabled</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <i class="bi bi-file-earmark-zip"></i>Extract Size (bytes)
                </label>
                <input type="number" 
                  formControlName="extractSize" 
                  placeholder="0">
                @if (imageForm.get('extractSize')?.value) {
                  <div class="field-help">{{ formatBytes(imageForm.get('extractSize')?.value || 0) }}</div>
                }
              </div>
              <div class="form-group">
                <label>
                  <i class="bi bi-cloud-download"></i>Download Size (bytes)
                </label>
                <input type="number" 
                  formControlName="imageDownloadSize" 
                  placeholder="0">
                @if (imageForm.get('imageDownloadSize')?.value) {
                  <div class="field-help">{{ formatBytes(imageForm.get('imageDownloadSize')?.value || 0) }}</div>
                }
              </div>
            </div>

            <div class="form-row single">
              <div class="form-group">
                <label>
                  <i class="bi bi-shield-check"></i>SHA256 Hash
                </label>
                <input type="text" 
                  formControlName="extractSha256" 
                  placeholder="Enter SHA256 hash"
                  style="font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; font-size: 0.8rem;">
                <div class="field-help">SHA256 hash for file integrity verification</div>
              </div>
            </div>
          </div>

          <!-- Icon & Preview -->
          <div class="form-card icon-card">
            <h3 class="card-title">
              <i class="bi bi-image"></i>Icon & Preview
            </h3>
            
            <!-- Preview oben, zentriert -->
            <div class="icon-preview"
              [class.loading]="currentIcon && iconLoading"
              [class.success]="currentIcon && iconLoaded" 
              [class.error]="currentIcon && !iconLoaded && !iconLoading">
              @if (currentIcon) {
                <img [src]="currentIcon" alt="Icon preview" (load)="onIconLoad()" (error)="onIconError()">
              } @else {
                <div class="placeholder">
                  <i class="bi bi-image"></i>
                  <span>Icon Preview</span>
                </div>
              }
            </div>
            
            <!-- Input unten -->
            <div class="icon-input-group">
              <div class="form-group">
                <label>
                  <i class="bi bi-link-45deg"></i>Icon URL
                </label>
                <input type="url" 
                  formControlName="icon" 
                  placeholder="https://example.com/icon.png"
                  (input)="onIconChange($event)">
              </div>
            </div>
            
            <!-- Status unten -->
            <div class="icon-status" 
              [class.success]="currentIcon && iconLoaded"
              [class.error]="currentIcon && !iconLoaded && !iconLoading"
              [class.loading]="currentIcon && iconLoading"
              [class.neutral]="!currentIcon">
              @if (!currentIcon) {
                üí° Enter a URL above to preview the icon
              } @else if (iconLoading) {
                ‚è≥ Loading icon...
              } @else if (iconLoaded) {
                ‚úÖ Icon loaded successfully
              } @else {
                ‚ùå Failed to load icon - check the URL
              }
            </div>
          </div>
        </div>

        <!-- Right Column: URLs & Lists -->
        <div class="right-column">
          <!-- Download URLs -->
          <div class="form-card">
            <h3 class="card-title">
              <i class="bi bi-cloud-download"></i>Download URLs
            </h3>
            
            <div class="url-list">
              @for (url of imageUrls; track $index) {
                <div class="url-item">
                  <input type="url" 
                    class="url-input"
                    [(ngModel)]="url.url"
                    placeholder="https://example.com/download/os-image.img"
                    [ngModelOptions]="{standalone: true}">
                  <div class="url-controls">
                    <div class="url-status" 
                      [class.available]="url.isAvailable === true"
                      [class.unavailable]="url.isAvailable === false"
                      [class.checking]="url.isAvailable === null"
                      [title]="url.isAvailable === true ? 'Available' : url.isAvailable === false ? 'Unavailable' : 'Checking...'">
                    </div>
                    <div class="url-actions">
                      <button type="button" 
                        class="favorite-url"
                        (click)="toggleFavorite($index)"
                        [class.active]="url.isDefault"
                        [title]="url.isDefault ? 'Remove from favorites' : 'Set as favorite (default)'">
                        <i class="bi" [class.bi-star]="!url.isDefault" [class.bi-star-fill]="url.isDefault"></i>
                      </button>
                      <button type="button" 
                        class="remove-url"
                        (click)="removeUrl($index)"
                        [title]="'Remove URL'">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
              }
              
              <div class="add-url">
                <input type="url" 
                  [(ngModel)]="newUrlInput"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Add new download URL..."
                  (keyup.enter)="addUrl()">
                <button type="button" 
                  class="add-btn"
                  (click)="addUrl()"
                  [disabled]="!newUrlInput.trim()">
                  <i class="bi bi-plus-lg"></i> Add
                </button>
              </div>
            </div>
          </div>

          <!-- Lists Assignment -->
          <div class="form-card">
            <h3 class="card-title">
              <i class="bi bi-list-ul"></i>Assign to Lists
            </h3>
            
            <div class="lists-assignment">
              @for (list of availableLists; track list.id) {
                <div class="list-item" 
                     [class.selected]="isListSelected(list.id)"
                     (click)="toggleListById(list.id)">
                  <div class="list-info">
                    <div class="list-icon"></div>
                    <span class="list-name">{{ list.name }}</span>
                  </div>
                  <div class="list-checkbox">
                    <input type="checkbox" 
                      [checked]="isListSelected(list.id)"
                      (change)="toggleList(list.id, $event)"
                      (click)="$event.stopPropagation()">
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button type="button" 
      class="btn-secondary-modern"
      (click)="modal.dismiss()">
      <i class="bi bi-x me-2"></i>Cancel
    </button>
    <button type="submit" 
      class="btn-primary-modern"
      (click)="onSubmit()"
      [disabled]="imageForm.invalid">
      <i class="bi bi-save me-2"></i>Save Changes
    </button>
  </div>
</div>