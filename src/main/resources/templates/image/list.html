<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Bilderverwaltung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .editable:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .edit-input {
            width: 100%;
            border: 1px solid #dee2e6;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-light">
<!-- Navigation unverändert -->

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Bilderverwaltung</h4>
            <a href="/images/edit" class="btn btn-light btn-sm">
                <i class="bi bi-plus-lg"></i> Neues Bild
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Beschreibung</th>
                        <th>Kategorie</th>
                        <th class="text-center">Aktiv</th>
                        <th class="text-center">Aktionen</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="image : ${images}">
                        <td class="editable" data-field="name" data-id="${image.id}">
                            <span class="display-text" th:text="${image.name}"></span>
                            <input type="text" class="edit-input d-none" th:value="${image.name}">
                        </td>
                        <td class="editable" data-field="description" data-id="${image.id}">
                            <span class="display-text" th:text="${image.description}"></span>
                            <input type="text" class="edit-input d-none" th:value="${image.description}">
                        </td>
                        <td th:text="${image.category?.name} ?: 'Keine Kategorie'"></td>
                        <td class="text-center">
                            <div class="form-check form-switch">
                                <input class="form-check-input status-toggle"
                                       type="checkbox"
                                       role="switch"
                                       th:checked="${image.isEnabled}"
                                       data-id="${image.id}">
                            </div>
                        </td>
                        <td class="text-center">
                            <form th:action="@{/images/delete}" method="post"
                                  class="d-inline" onsubmit="return confirm('Wirklich löschen?');">
                                <input type="hidden" name="id" th:value="${image.id}"/>
                                <input type="hidden" th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // CSRF Token für AJAX Requests
    const csrfToken = document.querySelector("input[name='_csrf']").value;
    const csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

    // Status Toggle
    document.querySelectorAll('.status-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const imageId = this.dataset.id;
            const isEnabled = this.checked;

            fetch(`/api/images/${imageId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ enabled: isEnabled })
            })
                .then(response => {
                    if (!response.ok) {
                        this.checked = !isEnabled; // Revert on error
                        throw new Error('Update fehlgeschlagen');
                    }
                    return response.json();
                })
                .catch(error => console.error('Error:', error));
        });
    });

    // Inline Editing
    document.querySelectorAll('.editable').forEach(cell => {
        cell.addEventListener('click', function(e) {
            const displayText = this.querySelector('.display-text');
            const inputField = this.querySelector('.edit-input');

            if (!inputField.classList.contains('d-none')) return;

            displayText.classList.add('d-none');
            inputField.classList.remove('d-none');
            inputField.focus();

            const initialValue = inputField.value;

            const saveChanges = () => {
                const newValue = inputField.value.trim();
                if (newValue === initialValue) {
                    cancelEdit();
                    return;
                }

                const imageId = this.dataset.id;
                const field = this.dataset.field;

                fetch(`/api/images/${imageId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ [field]: newValue })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Update fehlgeschlagen');
                        }
                        displayText.textContent = newValue;
                        cancelEdit();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        cancelEdit();
                    });
            };

            const cancelEdit = () => {
                inputField.value = initialValue;
                displayText.classList.remove('d-none');
                inputField.classList.add('d-none');
            };

            inputField.addEventListener('blur', saveChanges);
            inputField.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') saveChanges();
                if (e.key === 'Escape') cancelEdit();
            });
        });
    });
</script>
</body>
</html>
